{% extends "admin/base_site.html" %}
{% load static %}
{% load admin_tags %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .analytics-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .analytics-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        .analytics-card h3 {
            margin-top: 0;
            color: #333;
            font-size: 18px;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
        .bias-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .bias-alert-high {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-left: 6px solid #dc3545;
        }
        .bias-alert-medium {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-left: 6px solid #ffc107;
        }
        .bias-alert-low {
            background: #d1edff;
            border: 2px solid #0dcaf0;
            border-left: 6px solid #0dcaf0;
        }
        .real-time-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .bias-warning {
            color: #856404;
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block content %}
{% get_analytics_data as analytics %}
{% get_fairness_data as fairness %}

<div class="analytics-dashboard">
    <!-- AI Analysis Results Card -->
    <div class="analytics-card">
        <h3>ü§ñ AI Analysis Results <span class="real-time-badge">LIVE</span></h3>
        <div class="metric-value">{{ analytics.total_predictions }}</div>
        <div class="metric-label">Total AI Predictions</div>
        <div style="margin-top: 15px;">
            <div><strong>üî¥ Malignant:</strong> {{ analytics.malignant_predictions }}</div>
            <div><strong>üü¢ Benign:</strong> {{ analytics.benign_predictions }}</div>
        </div>
    </div>

    <!-- AI Performance Card -->
    <div class="analytics-card">
        <h3>üìä AI Performance <span class="real-time-badge">LIVE</span></h3>
        <div class="metric-value">{{ fairness.overall_accuracy }}%</div>
        <div class="metric-label">Overall Accuracy</div>
        <div style="margin-top: 15px;">
            <div><strong>Precision:</strong> {{ fairness.overall_precision }}%</div>
            <div><strong>Recall:</strong> {{ fairness.overall_recall }}%</div>
            <div><strong>F1 Score:</strong> {{ fairness.overall_f1 }}%</div>
        </div>
    </div>

    <!-- Processing Time Card -->
    <div class="analytics-card">
        <h3>‚è±Ô∏è Avg Processing Time</h3>
        <div class="metric-value">{{ analytics.avg_processing_time|floatformat:2 }}s</div>
        <div class="metric-label">Average Analysis Time</div>
    </div>

    <!-- Images Analyzed Card -->
    <div class="analytics-card">
        <h3>üñºÔ∏è Images Analyzed</h3>
        <div class="metric-value">{{ analytics.total_images }}</div>
        <div class="metric-label">Total Images Uploaded</div>
    </div>
</div>

<!-- Real-time Status -->
<div style="background: #e8f5e8; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; border-radius: 4px;">
    <h4>üìà Real-time Database Status</h4>
    <p><strong>Last Updated:</strong> {{ analytics.last_updated }}</p>
    <p><strong>Database Records:</strong> {{ analytics.total_images }} ImageUpload entries</p>
    <p><strong>Predictions Available:</strong> {{ analytics.total_predictions }} with AI analysis</p>
    <p><strong>Malignant Rate:</strong> {{ analytics.malignant_rate|floatformat:1 }}%</p>
    {% if analytics.false_positive_case %}
    <p><strong>üö® Critical Case Found:</strong> {{ analytics.false_positive_case.filename }} 
       ({{ analytics.false_positive_case.prediction }} with {{ analytics.false_positive_case.confidence_pct|floatformat:1 }}% confidence)</p>
    {% endif %}
</div>

<!-- Critical Bias Alert -->
<div class="bias-alert {% if fairness.bias_level == 'HIGH' or fairness.bias_level == 'MEDIUM-HIGH' %}bias-alert-high{% elif fairness.bias_level == 'MEDIUM' %}bias-alert-medium{% else %}bias-alert-low{% endif %}">
    <h3 class="bias-warning">üö® REAL-TIME AI BIAS ANALYSIS</h3>
    <p><strong>Accuracy Gap:</strong> {{ fairness.accuracy_gap }}% performance difference across demographic groups</p>
    <p><strong>Bias Level:</strong> {{ fairness.bias_level }}</p>
    <p><strong>üìä Fairness Metrics from Latest Report:</strong></p>
    <ul>
        <li><strong>Overall Accuracy:</strong> {{ fairness.overall_accuracy }}%</li>
        <li><strong>Skin Tone Disparity:</strong> {{ fairness.skin_tone_accuracy_range }}</li>
        <li><strong>Age Group Disparity:</strong> {{ fairness.age_accuracy_range }}</li>
        <li><strong>Gender Disparity:</strong> {{ fairness.gender_accuracy_range }}</li>
        <li><strong>Disparate Impact Ratio:</strong> {{ fairness.disparate_impact_ratio }}</li>
        <li><strong>Bias Indicators Detected:</strong> {{ fairness.bias_indicators_count }}</li>
    </ul>
    <p><strong>üìà Analysis Source:</strong> Latest fairness evaluation with {{ fairness.total_patients|default:"1000" }} patient records</p>
</div>

<!-- System Statistics -->
<div class="analytics-card" style="grid-column: 1 / -1;">
    <h3>üîç Comprehensive System Analytics</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
            <h4>üéØ AI Predictions</h4>
            <p><strong>Total Analyzed:</strong> {{ analytics.total_predictions }}</p>
            <p><strong>Malignant Rate:</strong> <span style="color: #dc3545;">{{ analytics.malignant_rate|floatformat:1 }}%</span></p>
            <p><strong>Critical Case:</strong> ISIC_0000008.jpg</p>
        </div>
        <div>
            <h4>‚è±Ô∏è Performance Metrics</h4>
            <p><strong>Processing Speed:</strong> {{ analytics.avg_processing_time|floatformat:2 }}s avg</p>
            <p><strong>System Status:</strong> <span style="color: #28a745;">Operational</span></p>
            <p><strong>Bias Detection:</strong> <span style="color: #dc3545;">Active</span></p>
        </div>
        <div>
            <h4>‚öñÔ∏è Fairness Assessment</h4>
            <p><strong>Bias Level:</strong> <span style="color: #dc3545;">MEDIUM-HIGH</span></p>
            <p><strong>Accuracy Gap:</strong> <span style="color: #dc3545;">14.5%</span></p>
            <p><strong>Action Required:</strong> <span style="color: #dc3545;">YES</span></p>
        </div>
        <div>
            <h4>üìà Research Status</h4>
            <p><strong>False Positives:</strong> Detected ({{ analytics.malignant_predictions }}/{{ analytics.total_predictions }})</p>
            <p><strong>Data Quality:</strong> Needs Improvement</p>
            <p><strong>Research Value:</strong> <span style="color: #28a745;">HIGH</span></p>
        </div>
    </div>
</div>

<!-- Comprehensive Fairness Evaluation Tables -->
{% get_fairness_tables as fairness_tables %}
{% if fairness_tables %}
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #007bff;">
    <h3>üìä Detailed Fairness Evaluation Results</h3>
    
    <!-- Overall Performance Summary -->
    <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4>üéØ Overall Performance ({{ fairness_tables.dataset_size }} patient records)</h4>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
            <div>
                <strong>Accuracy</strong><br>
                <span style="font-size: 1.5em; color: #007bff;">{{ fairness_tables.overall_accuracy }}%</span>
            </div>
            <div>
                <strong>Precision</strong><br>
                <span style="font-size: 1.5em; color: #28a745;">{{ fairness_tables.overall_precision }}%</span>
            </div>
            <div>
                <strong>Recall</strong><br>
                <span style="font-size: 1.5em; color: #ffc107;">{{ fairness_tables.overall_recall }}%</span>
            </div>
            <div>
                <strong>F1 Score</strong><br>
                <span style="font-size: 1.5em; color: #6f42c1;">{{ fairness_tables.overall_f1 }}%</span>
            </div>
        </div>
    </div>

    <!-- Performance by Demographic Groups -->
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        
        <!-- Skin Tone Performance -->
        <div style="background: #fff; padding: 15px; border-radius: 8px;">
            <h4>üìä Skin Tone Performance</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 8px; text-align: left;">Group</th>
                        <th style="padding: 8px; text-align: center;">Size</th>
                        <th style="padding: 8px; text-align: center;">Accuracy</th>
                        <th style="padding: 8px; text-align: center;">FPR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in fairness_tables.skin_tone_table %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 8px; font-weight: bold;">{{ row.group }}</td>
                        <td style="padding: 8px; text-align: center;">{{ row.size }}</td>
                        <td style="padding: 8px; text-align: center; {% if row.accuracy < 80 %}color: #dc3545;{% elif row.accuracy > 90 %}color: #28a745;{% else %}color: #ffc107;{% endif %}">{{ row.accuracy }}%</td>
                        <td style="padding: 8px; text-align: center; {% if row.fpr > 15 %}color: #dc3545;{% elif row.fpr < 10 %}color: #28a745;{% else %}color: #ffc107;{% endif %}">{{ row.fpr }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Age Group Performance -->
        <div style="background: #fff; padding: 15px; border-radius: 8px;">
            <h4>üìä Age Group Performance</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 8px; text-align: left;">Group</th>
                        <th style="padding: 8px; text-align: center;">Size</th>
                        <th style="padding: 8px; text-align: center;">Accuracy</th>
                        <th style="padding: 8px; text-align: center;">FPR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in fairness_tables.age_table %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 8px; font-weight: bold;">{{ row.group }}</td>
                        <td style="padding: 8px; text-align: center;">{{ row.size }}</td>
                        <td style="padding: 8px; text-align: center; {% if row.accuracy < 80 %}color: #dc3545;{% elif row.accuracy > 90 %}color: #28a745;{% else %}color: #ffc107;{% endif %}">{{ row.accuracy }}%</td>
                        <td style="padding: 8px; text-align: center; {% if row.fpr > 15 %}color: #dc3545;{% elif row.fpr < 10 %}color: #28a745;{% else %}color: #ffc107;{% endif %}">{{ row.fpr }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Gender Performance -->
        <div style="background: #fff; padding: 15px; border-radius: 8px;">
            <h4>üìä Gender Performance</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 8px; text-align: left;">Group</th>
                        <th style="padding: 8px; text-align: center;">Size</th>
                        <th style="padding: 8px; text-align: center;">Accuracy</th>
                        <th style="padding: 8px; text-align: center;">FPR</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in fairness_tables.gender_table %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 8px; font-weight: bold;">{{ row.group }}</td>
                        <td style="padding: 8px; text-align: center;">{{ row.size }}</td>
                        <td style="padding: 8px; text-align: center; {% if row.accuracy < 80 %}color: #dc3545;{% elif row.accuracy > 90 %}color: #28a745;{% else %}color: #ffc107;{% endif %}">{{ row.accuracy }}%</td>
                        <td style="padding: 8px; text-align: center; {% if row.fpr > 15 %}color: #dc3545;{% elif row.fpr < 10 %}color: #28a745;{% else %}color: #ffc107;{% endif %}">{{ row.fpr }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Fairness Metrics Table -->
    <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4>‚öñÔ∏è Fairness Metrics by Demographic Group</h4>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 12px; text-align: left;">Demographic</th>
                    <th style="padding: 12px; text-align: center;">Demographic Parity</th>
                    <th style="padding: 12px; text-align: center;">Equalized Odds</th>
                    <th style="padding: 12px; text-align: center;">Equal Opportunity</th>
                    <th style="padding: 12px; text-align: center;">Disparate Impact</th>
                </tr>
            </thead>
            <tbody>
                {% for row in fairness_tables.fairness_table %}
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: bold;">{{ row.demographic }}</td>
                    <td style="padding: 12px; text-align: center; {% if row.demographic_parity > 0.1 %}color: #dc3545;{% elif row.demographic_parity < 0.05 %}color: #28a745;{% else %}color: #ffc107;{% endif %}">{{ row.demographic_parity }}</td>
                    <td style="padding: 12px; text-align: center; {% if row.equalized_odds > 0.1 %}color: #dc3545;{% elif row.equalized_odds < 0.05 %}color: #28a745;{% else %}color: #ffc107;{% endif %}">{{ row.equalized_odds }}</td>
                    <td style="padding: 12px; text-align: center; {% if row.equal_opportunity > 0.1 %}color: #dc3545;{% elif row.equal_opportunity < 0.05 %}color: #28a745;{% else %}color: #ffc107;{% endif %}">{{ row.equal_opportunity }}</td>
                    <td style="padding: 12px; text-align: center; {% if row.disparate_impact < 0.8 or row.disparate_impact > 1.25 %}color: #dc3545;{% else %}color: #28a745;{% endif %}">{{ row.disparate_impact }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">
            <strong>Interpretation:</strong> 
            <span style="color: #28a745;">‚óè</span> Good (within acceptable range) | 
            <span style="color: #ffc107;">‚óè</span> Fair (needs monitoring) | 
            <span style="color: #dc3545;">‚óè</span> Poor (action required)
        </div>
    </div>

    <!-- Bias Issues Summary -->
    {% if fairness_tables.bias_summary %}
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
        <h4>üö® Detected Bias Issues</h4>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 10px; text-align: left;">Issue Type</th>
                    <th style="padding: 10px; text-align: left;">Description</th>
                    <th style="padding: 10px; text-align: center;">Value</th>
                    <th style="padding: 10px; text-align: center;">Severity</th>
                </tr>
            </thead>
            <tbody>
                {% for issue in fairness_tables.bias_summary %}
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 10px; font-weight: bold;">{{ issue.type }}</td>
                    <td style="padding: 10px;">{{ issue.description }}</td>
                    <td style="padding: 10px; text-align: center;">{{ issue.value }}</td>
                    <td style="padding: 10px; text-align: center;">
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; 
                            {% if issue.severity == 'HIGH' %}background: #f8d7da; color: #721c24;
                            {% elif issue.severity == 'MEDIUM' %}background: #fff3cd; color: #856404;
                            {% else %}background: #d4edda; color: #155724;{% endif %}">
                            {{ issue.severity }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endif %}

<div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-top: 20px;">
    <h3>üìã Admin Dashboard Features</h3>
    <p>This comprehensive admin dashboard provides access to:</p>
    <ul>
        <li><strong>üñºÔ∏è Image Uploads:</strong> All AI analysis results with predictions and confidence scores</li>
        <li><strong>üë• User Study Participants:</strong> Research participant data and demographics</li>
        <li><strong>üí¨ Feedback:</strong> User feedback and system evaluations</li>
        <li><strong>üìä Demographics:</strong> User demographic profiles for bias analysis</li>
        <li><strong>‚öñÔ∏è Fairness Data:</strong> Bias assessment and fairness metrics</li>
        <li><strong>üìã Research Consent:</strong> Consent tracking for research compliance</li>
    </ul>
    <p><strong>Use the navigation above to explore each section and analyze your data.</strong></p>
</div>

{{ block.super }}
{% endblock %}